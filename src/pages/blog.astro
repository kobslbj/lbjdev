---
import { getCollection } from "astro:content";
import BaseLayout from '../layouts/BaseLayout.astro';

const pageTitle = "Blog";
const pageDescription = "記錄在軟體開發與創業路上的所學。"
const authorName = "Justin Li";

const allPosts = (await getCollection("posts")).sort(
  (a, b) => new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
);
---
<BaseLayout pageTitle={pageTitle} pageDescription={pageDescription}>
  <section>
      <div>
        <ul id="article-list">
          {allPosts.map((post) => (
            <li class="py-6 border-b border-[#2A2D32]">
              <p class="text-xs uppercase tracking-wide text-[#8B949E]">{post.data.tags[0] ?? 'Article'}</p>
              <h2 class="mt-2 text-2xl sm:text-3xl font-bold">
                <a href={`/posts/${post.slug}/`} class="text-[#E6EDF3] hover:text-[#79C0FF]">{post.data.title}</a>
              </h2>
              <p class="mt-3 text-[#C9D1D9] max-w-3xl">{post.data.description}</p>
              <p class="mt-3 text-sm text-[#8B949E]">{authorName} on {new Date(post.data.pubDate).toDateString().split(' ').slice(1,3).join(' ')} {new Date(post.data.pubDate).getFullYear()}</p>
            </li>
          ))}
        </ul>
    </div>
  </section>
  <script is:inline>
    const posts = JSON.parse('{JSON.stringify(allPosts.map(p => ({ slug: p.slug, title: p.data.title, description: p.data.description, pubDate: p.data.pubDate, tags: p.data.tags })))}');
    const articleList = document.getElementById('article-list');
    const author = 'Justin Li';

    function formatDate(iso) {
      const d = new Date(iso);
      return `${d.toDateString().split(' ').slice(1,3).join(' ')} ${d.getFullYear()}`;
    }

    function render(list) {
      articleList.innerHTML = list.map(p => `
        <li class=\"py-8 border-b border-[#2A2D32]\">
          <p class=\"text-xs uppercase tracking-wide text-[#8B949E]\">${(p.tags && p.tags[0]) || 'Article'}</p>
          <h2 class=\"mt-2 text-2xl sm:text-3xl font-bold\"><a class=\"text-[#E6EDF3] hover:text-[#79C0FF]\" href=\"/posts/${p.slug}/\">${p.title}</a></h2>
          <p class=\"mt-3 text-[#C9D1D9] max-w-3xl\">${p.description || ''}</p>
          <p class=\"mt-3 text-sm text-[#8B949E]\">${author} on ${formatDate(p.pubDate)}</p>
        </li>`).join('');
    }

    // initial render
    render(posts);
  </script>

</BaseLayout>